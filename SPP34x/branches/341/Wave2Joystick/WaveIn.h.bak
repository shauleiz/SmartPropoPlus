#pragma once

#include <math.h>
#include "SmartPropoPlus.h"
#include "GenWave.h"
#include "jr.h"
#include "futaba.h"
#include "airtronics.h"
#include "Logger.h"

#define	POLLING_PERIOD	20	// in Milliseconds

DWORD WINAPI g_WaveInThreadProc(LPVOID arg);
DWORD WINAPI g_ReadWaveFileThreadProc(LPVOID arg);
VOID CALLBACK TimerCompletionRoutine(LPVOID lpArg,   DWORD dwTimerLowValue,   DWORD dwTimerHighValue );

class CWaveIn
{
public:
	CWaveIn(void);
	virtual ~CWaveIn(void);

	/* Interface with CWave2Joystick*/
	bool Init(int id);
	bool			Start();
	bool			Stop();
	int				GetId();
	bool			SetModulation(const MODE Type); 
	void			SetJoystickEventCallback(void FAR * callbackfunc, void FAR * Obj);
	bool SendJoystickData(bool force=false);// Send Joystick data (if channged). Returnes true if sent or false if not sent
	LONG			GetWaveDataFromLogger(void * buffer, int * size);
	int				GetAudioLevel(void);


	/* Interface with the thread that called by the driver  */
	void			FAR ProcessBuffer(WAVEHDR * hdr, HWAVEIN hDevice);
	void			__fastcall ProcessData(int i);


private:
	int				m_id;								// WaveIn ID (Default = -1)
	TCHAR *			m_DeviceName;						// Name of the MIXER device than owns this WaveIn device
	HWAVEIN			m_hWaveIn;							// Handle to Wave In device
	WAVEFORMATEX	m_waveFmt;							// WAVE FORMAT (IN)
	WAVEFORMATEX	m_waveFmtRd;						// WAVE FORMAT (Reading WAV file)
	WAVEHDR			*m_waveBuf[N_WAVEIN_BUF];			// Array of poiters to audio buffers /* Version 3.3.5 - Vista compatability */
	DWORD			m_waveInThreadId;					// Id of the processing thread
	int				m_Position[MAX_JS_CH];				// Array of joystick position values
	int				m_nPositions;						// Number of active channels
	int				m_waveBufSize ;
	class Wave2Joystick *	m_JoystickTargetObj;		// Target Object to from which the joystick callback is executed
	void *			m_JoystickTargetFunc;				// Pointer to joystick callback
	DWORD			m_ThreadId;							// ID of the current thread
	CLogger *		m_LogWr;							// Object that handles logging (Write Operation)
	CLogger *		m_LogRd;							// Object that handles logging (Read Operation)
	int				m_AudioLevel;						// Audio level (volume) of the raw audio signal 


private:
	// All ProcessPulseXXX functions + one placeholder function
	int		(CWaveIn::*m_ProcessPulse)(int, BOOL);
	int		ProcessPulsePpm(int width, BOOL input);
	int		ProcessPulseJrPpm(int width, BOOL input);
	int		ProcessPulseFutabaPpm(int width, BOOL input);
	int		ProcessPulseWalPcm(int width, BOOL input);
	int		ProcessPulseAirPcm1(int width, BOOL input);
	int		ProcessPulseAirPcm2(int width, BOOL input);
	int		ProcessPulseJrPcm(int width, BOOL input);
	int		ProcessPulseFutabaPcm(int width, BOOL input);

	// Walkera PCM helper functions
	unsigned char	WalkeraConvert2Bin(int width);
	unsigned char	WalkeraConvert2Oct(int width);
	int				WalkeraElevator(const unsigned char * cycle);
	int				WalkeraAilerons(const unsigned char * cycle);
	int				WalkeraThrottle(const unsigned char * cycle);
	int				WalkeraRudder(const unsigned char * cycle);
	int				WalkeraGear(const unsigned char * cycle);
	int				WalkeraPitch(const unsigned char * cycle);
	int				WalkeraGyro(const unsigned char * cycle);
	int				WalkeraChannel8(const unsigned char * cycle);
	int	*			WalkeraCheckSum(const unsigned char * cycle);

	// PP Helper functions
	int  __fastcall Convert15bits(unsigned int in);
	int  __fastcall Convert20bits(int in);

	// Debug functions
	void DebugPrintChannels(bool changed);

	// Volume
	int CalcAudioLevel(int Value, int Size);

public:
	// Create a WAV file for logging purpose and return its name
	TCHAR * StartWaveFileLog(void);
	bool StopWaveFileLog(void);
	bool PlayWaveFileLog(TCHAR * LogFileName);
	bool StatWaveFileLog(int * stat);
	bool m_PlayStopped, m_PlayEnded;
};
